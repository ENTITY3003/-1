// ================
// Ø¹Ù†Ø§ØµØ± Ø§ØµÙ„ÛŒ Ø¨Ø§Ø²ÛŒ
// ================
const game = document.getElementById('game');
const player = document.getElementById('player');
const scoreElement = document.getElementById('score');
const splashScreen = document.getElementById('splash-screen');
const startScreen = document.getElementById('start-screen');
const gameOverScreen = document.getElementById('game-over');
const finalScoreElement = document.getElementById('final-score');
const leftBtn = document.getElementById('left-btn');
const rightBtn = document.getElementById('right-btn');
const fireBtn = document.getElementById('fire-btn');
const musicControl = document.getElementById('music-control');
const musicIcon = document.getElementById('music-icon');

// ================
// Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ
// ================
let gameActive = false;
let score = 0;
let playerX = 50; // Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¨Ø§Ø²ÛŒÚ©Ù† (Ø¯Ø±ØµØ¯)
let enemies = [];
let bullets = [];
let enemyInterval, gameInterval;
let musicPlaying = false;

// Ù…ÙˆØ³ÛŒÙ‚ÛŒ ÙˆØ±Ø²Ø´ÛŒ Ø§Ù†Ø±Ú˜ÛŒØ²Ø§
const bgMusic = new Audio();
bgMusic.loop = true;

// Ù„ÛŒØ³Øª Ø¢Ù‡Ù†Ú¯â€ŒÙ‡Ø§ÛŒ ÙˆØ±Ø²Ø´ÛŒ Ø§Ù†Ø±Ú˜ÛŒØ²Ø§
const musicTracks = [
    "https://cdn.pixabay.com/download/audio/2021/08/09/audio_9b5d7fbaa7.mp3?filename=energetic-rock-142240.mp3",
    "https://cdn.pixabay.com/download/audio/2022/03/19/audio_0d5c9d2d5c.mp3?filename=action-sport-trailer-112571.mp3",
    "https://cdn.pixabay.com/download/audio/2021/10/29/audio_7dda2d4f92.mp3?filename=sports-action-11742.mp3"
];

// Ø§Ù†ØªØ®Ø§Ø¨ ØªØµØ§Ø¯ÙÛŒ ÛŒÚ© Ø¢Ù‡Ù†Ú¯
bgMusic.src = musicTracks[Math.floor(Math.random() * musicTracks.length)];

// Ø§ÛŒØ¬Ø§Ø¯ Ø§Ø¨Ø±Ù‡Ø§ÛŒ Ø²Ù…ÛŒÙ†Ù‡
function createBackground() {
    for (let i = 0; i < 10; i++) {
        const cloud = document.createElement('div');
        cloud.className = 'cloud';
        cloud.style.width = Math.random() * 120 + 60 + 'px';
        cloud.style.height = Math.random() * 50 + 30 + 'px';
        cloud.style.top = Math.random() * 40 + 10 + '%';
        cloud.style.opacity = Math.random() * 0.5 + 0.3;
        cloud.style.animationDuration = (Math.random() * 25 + 25) + 's';
        cloud.style.left = Math.random() * 100 + '%';
        game.appendChild(cloud);
    }
    
    for (let i = 0; i < 40; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        star.style.width = Math.random() * 4 + 1 + 'px';
        star.style.height = star.style.width;
        star.style.top = Math.random() * 100 + '%';
        star.style.left = Math.random() * 100 + '%';
        star.style.animationDelay = Math.random() * 3 + 's';
        game.appendChild(star);
    }
}

// Ø§ÛŒØ¬Ø§Ø¯ ÙˆÛŒÚ˜ÙˆØ§Ù„Ø§ÛŒØ²Ø± Ù…ÙˆØ³ÛŒÙ‚ÛŒ
function createVisualizer() {
    const visualizer = document.createElement('div');
    visualizer.className = 'visualizer';
    
    for (let i = 0; i < 50; i++) {
        const bar = document.createElement('div');
        bar.className = 'bar';
        bar.style.setProperty('--i', i);
        bar.style.setProperty('--height', Math.random() * 40 + 'px');
        bar.style.animationDuration = (Math.random() * 0.5 + 0.4) + 's';
        visualizer.appendChild(bar);
    }
    
    game.appendChild(visualizer);
}

// ================
// ØªÙˆØ§Ø¨Ø¹ Ú©Ù†ØªØ±Ù„ Ø¨Ø§Ø²ÛŒ
// ================

// Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ
function startGame() {
    gameActive = true;
    score = 0;
    playerX = 50;
    
    scoreElement.textContent = 'Ø§Ù…ØªÛŒØ§Ø²: ' + score;
    startScreen.style.display = 'none';
    gameOverScreen.style.display = 'none';
    player.style.left = '50%';
    
    // Ø­Ø°Ù ØªÙ…Ø§Ù… Ø¯Ø´Ù…Ù†Ø§Ù† Ùˆ Ú¯Ù„ÙˆÙ„Ù‡ Ù‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ
    document.querySelectorAll('.enemy, .bullet, .explosion').forEach(el => el.remove());
    enemies = [];
    bullets = [];
    
    // Ø§ÛŒØ¬Ø§Ø¯ Ø²Ù…ÛŒÙ†Ù‡
    document.querySelectorAll('.cloud, .star, .visualizer').forEach(el => el.remove());
    createBackground();
    createVisualizer();
    
    // Ø´Ø±ÙˆØ¹ ØªÙˆÙ„ÛŒØ¯ Ø¯Ø´Ù…Ù†
    if (enemyInterval) clearInterval(enemyInterval);
    enemyInterval = setInterval(createEnemy, 1600); // Ø³Ø±Ø¹Øª Ú©Ù…ØªØ±ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ø´Ù…Ù†Ø§Ù†
    
    // Ø´Ø±ÙˆØ¹ Ø¨Ù‡ Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¨Ø§Ø²ÛŒ
    if (gameInterval) clearInterval(gameInterval);
    gameInterval = setInterval(updateGame, 30);
    
    // Ù¾Ø®Ø´ Ù…ÙˆØ³ÛŒÙ‚ÛŒ
    if (musicPlaying) {
        bgMusic.play();
    }
}

// Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§Ø²ÛŒ
function endGame() {
    gameActive = false;
    finalScoreElement.textContent = score;
    gameOverScreen.style.display = 'flex';
    clearInterval(enemyInterval);
    clearInterval(gameInterval);
    
    // ØªÙˆÙ‚Ù Ù…ÙˆØ³ÛŒÙ‚ÛŒ
    bgMusic.pause();
    
    // Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ø§Ù†ÙØ¬Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²ÛŒÚ©Ù†
    const playerRect = player.getBoundingClientRect();
    createExplosion(playerRect.left + playerRect.width/2, playerRect.top + playerRect.height/2);
}

// Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø´Ù…Ù† Ø¬Ø¯ÛŒØ¯
function createEnemy() {
    if (!gameActive) return;
    
    const enemy = document.createElement('div');
    enemy.className = 'enemy';
    enemy.textContent = 'ğŸ›¸';
    const enemyX = Math.random() * (window.innerWidth - 50) + 25;
    enemy.style.left = enemyX + 'px';
    enemy.style.top = '-50px';
    
    game.appendChild(enemy);
    enemies.push({
        element: enemy,
        x: enemyX,
        y: -50
    });
}

// Ø´Ù„ÛŒÚ© Ú¯Ù„ÙˆÙ„Ù‡
function fireBullet() {
    if (!gameActive) return;
    
    const bullet = document.createElement('div');
    bullet.className = 'bullet';
    bullet.textContent = 'â†‘';
    
    const playerRect = player.getBoundingClientRect();
    const bulletX = playerRect.left + playerRect.width/2;
    const bulletY = playerRect.top;
    
    bullet.style.left = bulletX + 'px';
    bullet.style.top = bulletY + 'px';
    
    game.appendChild(bullet);
    bullets.push({
        element: bullet,
        x: bulletX,
        y: bulletY
    });
    
    // Ø§ÙÚ©Øª Ø´Ù„ÛŒÚ©
    player.style.transform = 'translateX(-50%) scale(1.1)';
    setTimeout(() => {
        player.style.transform = 'translateX(-50%) scale(1)';
    }, 100);
}

// Ø§ÛŒØ¬Ø§Ø¯ Ø§Ù†ÙØ¬Ø§Ø±
function createExplosion(x, y) {
    const explosion = document.createElement('div');
    explosion.className = 'explosion';
    explosion.textContent = 'ğŸ’¥';
    explosion.style.left = x + 'px';
    explosion.style.top = y + 'px';
    game.appendChild(explosion);
    
    setTimeout(() => {
        explosion.remove();
    }, 500);
}

// ØªØ´Ø®ÛŒØµ Ø¨Ø±Ø®ÙˆØ±Ø¯
function isColliding(rect1, rect2) {
    return rect1.left < rect2.right && 
           rect1.right > rect2.left && 
           rect1.top < rect2.bottom && 
           rect1.bottom > rect2.top;
}

// Ø¨Ù‡ Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¹Ù†Ø§ØµØ±
function updateGame() {
    if (!gameActive) return;
    
    // Ø­Ø±Ú©Øª Ø¯Ø´Ù…Ù†Ø§Ù† Ø¨Ù‡ Ù¾Ø§ÛŒÛŒÙ† Ø¨Ø§ Ø³Ø±Ø¹Øª Ú©Ø§Ù‡Ø´ ÛŒØ§ÙØªÙ‡
    for (let i = enemies.length - 1; i >= 0; i--) {
        const enemy = enemies[i];
        const enemyElement = enemy.element;
        
        // Ø³Ø±Ø¹Øª Ø¯Ø´Ù…Ù†Ø§Ù† Ú©Ø§Ù‡Ø´ ÛŒØ§ÙØª (Ø§Ø² 3 Ø¨Ù‡ 2)
        enemy.y += 2;
        enemyElement.style.top = enemy.y + 'px';
        
        // Ø¯Ø±ÛŒØ§ÙØª Ù…Ø®ØªØµØ§Øª ÙØ¹Ù„ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ´Ø®ÛŒØµ Ø¨Ø±Ø®ÙˆØ±Ø¯
        const enemyRect = enemyElement.getBoundingClientRect();
        
        // Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ø±Ø®ÙˆØ±Ø¯ Ø¨Ø§ Ø¨Ø§Ø²ÛŒÚ©Ù†
        const playerRect = player.getBoundingClientRect();
        if (isColliding(playerRect, enemyRect)) {
            endGame();
            return;
        }
        
        // Ø­Ø°Ù Ø¯Ø´Ù…Ù†Ø§Ù† Ø®Ø§Ø±Ø¬ Ø´Ø¯Ù‡
        if (enemy.y > window.innerHeight) {
            enemyElement.remove();
            enemies.splice(i, 1);
        }
    }
    
    // Ø­Ø±Ú©Øª Ú¯Ù„ÙˆÙ„Ù‡ Ù‡Ø§ Ø¨Ù‡ Ø³Ù…Øª Ø¨Ø§Ù„Ø§
    for (let i = bullets.length - 1; i >= 0; i--) {
        const bullet = bullets[i];
        const bulletElement = bullet.element;
        
        // Ø­Ø±Ú©Øª Ú¯Ù„ÙˆÙ„Ù‡ Ø¨Ù‡ Ø³Ù…Øª Ø¨Ø§Ù„Ø§
        bullet.y -= 10;
        bulletElement.style.top = bullet.y + 'px';
        
        // Ø¯Ø±ÛŒØ§ÙØª Ù…Ø®ØªØµØ§Øª ÙØ¹Ù„ÛŒ Ú¯Ù„ÙˆÙ„Ù‡
        const bulletRect = bulletElement.getBoundingClientRect();
        
        // Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ø±Ø®ÙˆØ±Ø¯ Ú¯Ù„ÙˆÙ„Ù‡ Ø¨Ø§ Ø¯Ø´Ù…Ù†
        for (let j = enemies.length - 1; j >= 0; j--) {
            const enemy = enemies[j];
            const enemyRect = enemy.element.getBoundingClientRect();
            
            if (isColliding(bulletRect, enemyRect)) {
                // Ø§ÛŒØ¬Ø§Ø¯ Ø§Ù†ÙØ¬Ø§Ø± Ø¯Ø± Ù…Ø­Ù„ Ø¨Ø±Ø®ÙˆØ±Ø¯
                createExplosion(
                    (bulletRect.left + bulletRect.right) / 2,
                    (bulletRect.top + bulletRect.bottom) / 2
                );
                
                // Ø­Ø°Ù Ø¯Ø´Ù…Ù† Ùˆ Ú¯Ù„ÙˆÙ„Ù‡
                enemy.element.remove();
                enemies.splice(j, 1);
                
                bulletElement.remove();
                bullets.splice(i, 1);
                
                // Ø§ÙØ²Ø§ÛŒØ´ Ø§Ù…ØªÛŒØ§Ø²
                score += 100;
                scoreElement.textContent = 'Ø§Ù…ØªÛŒØ§Ø²: ' + score;
                break;
            }
        }
        
        // Ø­Ø°Ù Ú¯Ù„ÙˆÙ„Ù‡ Ù‡Ø§ÛŒ Ø®Ø§Ø±Ø¬ Ø´Ø¯Ù‡
        if (bullet.y < -50) {
            bulletElement.remove();
            bullets.splice(i, 1);
        }
    }
}

// ================
// Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ú©Ù†ØªØ±Ù„
// ================

// Ú©Ù†ØªØ±Ù„ Ù…ÙˆØ³ÛŒÙ‚ÛŒ
musicControl.addEventListener('click', () => {
    if (musicPlaying) {
        bgMusic.pause();
        musicIcon.textContent = 'ğŸ”‡';
        musicPlaying = false;
    } else {
        bgMusic.play().catch(e => console.log("Ù„Ø·ÙØ§ ØªØ¹Ø§Ù…Ù„ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒØ¯ ØªØ§ Ù…ÙˆØ³ÛŒÙ‚ÛŒ Ù¾Ø®Ø´ Ø´ÙˆØ¯"));
        musicIcon.textContent = 'ğŸ”Š';
        musicPlaying = true;
    }
});

// Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ
document.getElementById('start-btn').addEventListener('click', startGame);
document.getElementById('restart-btn').addEventListener('click', startGame);

// Ø­Ø±Ú©Øª Ø¨Ù‡ Ú†Ù¾
leftBtn.addEventListener('click', function() {
    if (gameActive) {
        playerX = Math.max(10, playerX - 8);
        player.style.left = playerX + '%';
    }
});

// Ø­Ø±Ú©Øª Ø¨Ù‡ Ø±Ø§Ø³Øª
rightBtn.addEventListener('click', function() {
    if (gameActive) {
        playerX = Math.min(90, playerX + 8);
        player.style.left = playerX + '%';
    }
});

// Ø´Ù„ÛŒÚ©
fireBtn.addEventListener('click', function() {
    if (gameActive) {
        fireBullet();
    }
});

// Ú©Ù†ØªØ±Ù„ Ù„Ù…Ø³ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡ Ù‡Ø§
leftBtn.ontouchstart = function() {
    if (gameActive) {
        playerX = Math.max(10, playerX - 8);
        player.style.left = playerX + '%';
    }
};

rightBtn.ontouchstart = function() {
    if (gameActive) {
        playerX = Math.min(90, playerX + 8);
        player.style.left = playerX + '%';
    }
};

fireBtn.ontouchstart = function() {
    if (gameActive) {
        fireBullet();
    }
};

// Ú©Ù†ØªØ±Ù„ ØµÙØ­Ù‡ Ú©Ù„ÛŒØ¯
document.addEventListener('keydown', function(e) {
    if (!gameActive) return;
    
    if (e.key === 'ArrowLeft') {
        playerX = Math.max(10, playerX - 8);
        player.style.left = playerX + '%';
    } else if (e.key === 'ArrowRight') {
        playerX = Math.min(90, playerX + 8);
        player.style.left = playerX + '%';
    } else if (e.key === ' ' || e.key === 'Spacebar') {
        fireBullet();
    }
});

// Ø§Ø³Ù¾Ù„Ø´ Ø§Ø³Ú©Ø±ÛŒÙ† Ùˆ Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨Ù‡ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ
setTimeout(() => {
    splashScreen.style.display = 'none';
    startScreen.style.display = 'flex';
}, 3000);